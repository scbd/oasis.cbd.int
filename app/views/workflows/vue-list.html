<div data-app>
    <template>
        <v-card>
            <v-container fluid>
                <v-toolbar flat color="primary" dark>
                    <v-toolbar-title>Failed workflows</v-toolbar-title>
                </v-toolbar>
                
                    <v-data-table :headers="failedRecords.headers" :items="failedRecords.workflows" :single-expand="false" :expanded.sync="failedRecords.expanded" 
                    item-key="_id" show-expand class="elevation-1" :loading="failedRecords.loading" loading-text="Loading... Please wait"
                    :server-items-length="failedRecords.total" :options.sync="failedRecords.options">     
                       
                        <template v-slot:item.failedExecution.failDate="{ item }">
                            {{item.failedExecution.failDate  | formatDate('format','DD MMM YYYY HH:MM')}}
                        </template>
                        <template v-slot:item.failureProcessed="{ item }">
                            <div v-if="item.failureProcessed">
                                Failure Processed on {{item.failureProcessed.processedOn  | formatDate('format','DD MMM YYYY HH:MM')}}<br/>
                                ({{item.failureProcessed.processedBy}}) :- {{item.failureProcessed.action}}
                            </div>
                        </template>
                        <template v-slot:expanded-item="{ headers, item }">
                            <td :colspan="headers.length" style="padding:10px;">
                                <div>
                                    <v-card flat1 tile1 style="background: #eee;">        
                                        <table class="table">
                                            <tr><td colspan="2">Workflow details</td></tr>
                                            <tr>
                                                <td>
                                                    <table class="table table-bordered">
                                                        <tr>
                                                            <th colspan="4">Workflow Details</th>
                                                        </tr>
                                                        <tr>
                                                            <td style="width:35px">Realm</td><td>{{item.data.realm}}</td>
                                                            <td style="width:35px">Identifier</td>
                                                            <td>
                                                                <a target="_blank" :href="'https://api.cbd.int/api/v2013/documents/'+item.data.identifier">{{item.data.identifier}}</a> 
                                                                ({{item.data.documentID}})
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Schema</td><td>{{item.data.metadata.schema}}</td>
                                                            <td>Workflow Id</td><td>{{item._id}}</td>
                                                        </tr>
                                                        <tr>
                                                            <td>Type</td><td>{{item.type.name}}</td>
                                                            <td>Version</td><td>{{item.type.version}}</td>
                                                        </tr>
                                                        <tr>
                                                            <td>Created</td><td>{{item.createdOn}} ({{item.createdBy}})</td>
                                                            <td>Closed</td><td>{{item.closedOn}} ({{item.closedBy}})</td>
                                                        </tr>
                                                        <tr v-if="item.failedExecution.lockInfo">
                                                            <td>Lock Id</td><td>{{item.failedExecution.lockInfo.lockID}} ({{item.failedExecution.lockInfo.lockedOn}})</td>
                                                            <td>locked By</td>
                                                            <td>
                                                            {{item.failedExecution.lockInfo.lockedBy.firstName}} {{item.failedExecution.lockInfo.lockedBy.lastName  }}
                                                            ({{item.failedExecution.lockInfo.lockedBy.email}})</td>
                                                        </tr>
                                                    </table>
                                                </td>
                                                <td>
                                                     <table style="padding-top:10px" class="table table-bordered">
                                                        <tr>
                                                            <th colspan="3">Workflow Activities</th>
                                                        </tr>
                                                        <tr>                                                    
                                                            <td style="width:35px">Created on</td>           
                                                            <td style="width:35px">Closed on</td>           
                                                            <td style="width:35px">Canceled on</td>
                                                        </tr>
                                                        <tr v-for="activity in item.activities">
                                                            <td> {{activity.createdOn}} ({{activity.createdBy}})</td>
                                                            <td> {{activity.closedOn}} ({{activity.closedBy}})</td>
                                                            <td> {{activity.canceledOn}} ({{activity.canceledBy}})</td>
                                                        </tr>
                                                    </table>
                                                    <table class="table table-bordered">
                                                        <tr>
                                                            <th colspan="6">Failiure details (AWS SWF)</th>
                                                        </tr>
                                                        <tr>                                                    
                                                            <td style="width:35px">event Id</td>           
                                                            <td style="width:35px">Timestamp</td>           
                                                            <td style="width:35px">Type</td>         
                                                            <td style="width:35px">Parent Id</td>           
                                                            <td style="width:35px">Details</td>           
                                                            <td style="width:35px">Reason</td>
                                                        </tr>
                                                        <tr v-for="event in item.failedExecution.events">
                                                            <td> {{event.eventId}}</td>
                                                            <td> {{event.eventTimestamp}}</td>
                                                            <td> {{event.eventType}}</td>
                                                            <td> {{event.workflowExecutionFailedEventAttributes.decisionTaskCompletedEventId}}</td>
                                                            <td> {{event.workflowExecutionFailedEventAttributes.details}}</td>
                                                            <td> {{event.workflowExecutionFailedEventAttributes.reason}}</td>
                                                        </tr>
                                                    </table>

                                                </td>
                                            </tr>
                                            <tr v-if="item.validationErrors">
                                                <td colspan="2">
                                                    <table class="table table-bordered">
                                                        <tr style="background-color: #dd4b39;">
                                                            <td colspan="2">The draft record has validation Errors, please modify the record on the owner clearing-house</td>
                                                        </tr>
                                                        <tr v-for="error in item.validationErrors">
                                                            <td>{{error.code}}</td>
                                                            <td>{{error.property}}</td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>
                                        </table>
                                        <v-card-actions  v-if="!item.failureProcessed">
                                            <v-btn class="btn btn-primary" :disabled="failedRecords.updatingAction" :loading="failedRecords.updatingAction" @click="showProcessWorkflow(item)">No Action required</v-btn> &nbsp;
                                            <v-btn class="btn btn-warning" :disabled="failedRecords.updatingAction" :loading="failedRecords.updatingAction" @click="">Delete record lock</v-btn> &nbsp;
                                            <v-btn class="btn btn-danger"  :disabled="failedRecords.updatingAction" :loading="failedRecords.updatingAction" @click="startNewWorkflow(item)">Start new workflow</v-btn> &nbsp;                                    
                                        </v-card-actions>
                                    </v-card>
                                </div>
                            </td>
                        </template>
                    </v-data-table>

                    <v-dialog v-model="processWorkflowModel.show" max-width="500px">
                        <v-card>
                            <v-card-title>
                                Set workflow to processed
                            </v-card-title>
                            <hr />
                            <v-card-text>
                                <v-col cols="12">
                                    <v-textarea v-model="processWorkflowModel.action" label="Action taken" auto-grow outlined rows="1" row-height="15"></v-textarea>
                                </v-col>
                            </v-card-text>
                            <hr />
                            <v-card-actions>
                                <v-btn :disabled="failedRecords.updatingAction" :loading="failedRecords.updatingAction" class="btn btn-primary" @click="setFailedWorkflowToProcessed(processWorkflowModel.workflow)">Save</v-btn> &nbsp;
                                <v-btn :disabled="failedRecords.updatingAction" :loading="failedRecords.updatingAction" class="btn btn-default">Close</v-btn> &nbsp;
                            </v-card-actions>
                        </v-card>
                </v-dialog>
            </v-container>
        </v-card>
    </template>
    <!-- <div id="counter-component">
            <button v-on:click="decrement" type="button">-</button> 
        <input type="number" v-model="angularVueValue" v-on:input="countUpdated" />
        <button v-on:click="increment" type="button">+</button>
    </div> -->

</div> 
